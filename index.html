<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Mini App — Tap / Case / Inventory (v43)</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root{
    --bg1:#0f0f16; --bg2:#15182b; --fg:#eaeaea; --glass:rgba(255,255,255,.06); --gb:rgba(255,255,255,.22);
    --seg-h:56px; --stage-w:min(92vw,560px); --stage-h:clamp(220px,52vw,360px); --card-w:clamp(120px,28vw,220px);
  }
  html,body{height:100%;margin:0} *{-webkit-tap-highlight-color:transparent}
  body{
    color:var(--fg);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;user-select:none;overflow:hidden;
    background:
      radial-gradient(1100px 700px at 15% -10%, rgba(124,58,237,.25), transparent 60%),
      radial-gradient(1000px 800px at 100% 120%, rgba(255,59,129,.18), transparent 70%),
      linear-gradient(180deg,var(--bg1),var(--bg2));
  }
  /* header widgets */
  #wallet{position:fixed;top:10px;right:10px;z-index:30;display:inline-flex;align-items:center;gap:8px;
    padding:8px 12px;background:var(--glass);border:1px solid var(--gb);border-radius:12px;backdrop-filter:blur(4px)}
  #wallet img{width:22px;height:22px} #balance{font-weight:800}
  #reset-btn,#back-btn{position:fixed;left:10px;z-index:30;padding:8px 12px;font-size:12px;background:var(--glass);
    border:1px solid var(--gb);border-radius:12px;backdrop-filter:blur(4px)}
  #reset-btn{top:10px} #back-btn{top:44px;display:none}
  /* bottom nav */
  .segbar{position:fixed;left:0;right:0;bottom:0;height:calc(var(--seg-h) + env(safe-area-inset-bottom,0));
    display:grid;grid-template-columns:repeat(4,1fr);z-index:25;background:rgba(10,11,18,.7);backdrop-filter:blur(8px);
    border-top:1px solid var(--gb)}
  .seg{display:grid;place-items:center;color:#cfd3ff;font-size:12px;cursor:pointer}
  .seg+.seg{border-left:1px solid rgba(255,255,255,.08)}
  .seg.is-active{color:#fff;background:rgba(255,255,255,.10)}
  footer{position:fixed;bottom:calc(var(--seg-h) + 6px + env(safe-area-inset-bottom,0));left:10px;opacity:.45;font-size:12px;z-index:16}

  main{width:100%;height:100dvh;padding:16px 12px 8px;box-sizing:border-box;overflow:hidden}
  .view{height:100%} /* display управляем инлайном из JS */

  /* TAP */
  #tab-earn{display:grid;place-items:center}
  .tap-wrap{position:relative;display:grid;place-items:center;gap:12px}
  .tap-cat{height:92px;position:relative}
  .tap-cat img{height:92px;position:absolute;left:50%;transform:translateX(-50%);transition:opacity .08s}
  #cat1{opacity:1} #cat2{opacity:0}
  .btn{font-size:clamp(22px,5vw,40px);padding:22px 46px;border:0;border-radius:18px;color:#fff;cursor:pointer;
    background:linear-gradient(135deg,#ff3b30,#ff6a55);box-shadow:0 16px 40px rgba(255,59,48,.28), inset 0 -3px rgba(0,0,0,.25)}

  /* CASE LIST */
  #tab-case{overflow:auto;padding-top:72px;padding-bottom:calc(var(--seg-h) + 24px + env(safe-area-inset-bottom,0))}
  .case-list{display:grid;justify-items:center;gap:14px}
  .case-card{display:grid;gap:10px;justify-items:center;padding:14px;border-radius:14px;
    background:linear-gradient(135deg,rgba(124,58,237,.16),rgba(255,59,129,.12));border:1px solid var(--gb);cursor:pointer}
  .case-card img{width:min(70vw,340px);height:auto;object-fit:contain;border-radius:12px}
  .case-title{font-weight:800}.price{font-weight:800;opacity:.9}

  /* CASE OPEN */
  .open-wrap{display:none}
  .open-wrap.is-active{display:block}
  .stage{position:relative;width:var(--stage-w);height:var(--stage-h);margin:0 auto;border-radius:14px}
  .preview{position:absolute;inset:0;border-radius:14px;overflow:hidden;transition:opacity 320ms ease;opacity:1}
  .preview.hide{opacity:0}
  .preview img{width:100%;height:100%;object-fit:contain}
  .reel{position:absolute;inset:0;border-radius:14px;overflow:hidden;border:1px solid var(--gb);
    background:rgba(255,255,255,.06);opacity:0;transition:opacity 200ms ease}
  .reel.visible{opacity:1}
  .reel::after{content:'';position:absolute;top:0;bottom:0;left:50%;width:2px;transform:translateX(-1px);
    background:linear-gradient(180deg,transparent,rgba(255,255,255,.85),transparent)}
  .track{display:flex;align-items:center;height:100%;will-change:transform;transform:translate3d(0,0,0)}
  .card{flex:0 0 var(--card-w);width:var(--card-w);height:100%;display:grid;grid-template-rows:1fr auto;justify-items:center;gap:2px}
  .card img{width:calc(var(--card-w) - 6px);height:calc(var(--stage-h) - 52px);object-fit:contain;border-radius:10px;border:1px solid var(--gb);background:rgba(0,0,0,.15)}
  .card .label{font-size:12px;margin:0 0 4px;text-align:center}
  .card.win .label{color:#ffd400;text-shadow:0 0 12px rgba(255,212,0,.5)}
  .open-btn{display:block;margin:12px auto 10px;padding:14px 22px;border-radius:14px;border:0;color:#fff;cursor:pointer;
    background:linear-gradient(135deg,#7c3aed,#ff3b81)}
  .actions{display:none;gap:10px;justify-content:center}
  .actions.is-active{display:grid;grid-auto-flow:column}
  .a-btn{padding:12px 18px;border-radius:12px;border:0;color:#fff;cursor:pointer}
  .sell{background:linear-gradient(135deg,#0ea5e9,#2563eb)}
  .keep{background:linear-gradient(135deg,#22c55e,#16a34a)}

  /* Drops */
  .drops{margin:18px auto 0;max-width:var(--stage-w);display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;
    padding-bottom:120px}
  .drop{background:rgba(255,255,255,.06);border:1px solid var(--gb);border-radius:12px;padding:8px;display:grid;gap:6px;justify-items:center}
  .drop img{width:100%;height:120px;object-fit:contain;border:1px solid var(--gb);border-radius:8px;background:rgba(0,0,0,.15)}

  /* INVENTORY */
  #tab-inv{overflow:auto;padding:72px 12px calc(var(--seg-h) + 24px + env(safe-area-inset-bottom,0))}
  .inv{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px}
  .inv-card{background:rgba(255,255,255,.06);border:1px solid var(--gb);border-radius:12px;padding:8px;display:grid;gap:6px;justify-items:center}
  .inv-card img{width:100%;height:110px;object-fit:contain;border-radius:8px;border:1px solid var(--gb);background:rgba(0,0,0,.15)}
</style>
</head>
<body>
  <div id="wallet"><img src="hand.png" alt=""><span id="balance">0</span></div>
  <button id="reset-btn">обнуление</button>
  <button id="back-btn">назад</button>

  <audio id="sfx" preload="auto" playsinline>
    <source src="case_open.MP3" type="audio/mpeg">
    <source src="case_open.mp3" type="audio/mpeg">
  </audio>

  <main>
    <!-- TAP -->
    <section id="tab-earn" class="view" style="display:block">
      <div class="tap-wrap">
        <div class="tap-cat"><img id="cat1" src="cat1.png"><img id="cat2" src="cat2.png"></div>
        <button id="tap" class="btn">TAP</button>
      </div>
    </section>

    <!-- CASES -->
    <section id="tab-case" class="view" style="display:none">
      <div class="case-list" id="case-list">
        <div class="case-card" id="case-card">
          <div class="case-title">Сезонный Рома</div>
          <img src="case.png" alt="">
          <div class="price">50 Taps</div>
        </div>
      </div>

      <div id="open-wrap" class="open-wrap">
        <div class="stage">
          <div id="preview" class="preview"><img src="case.png" alt=""></div>
          <div id="reel" class="reel"><div id="track" class="track"></div></div>
        </div>
        <button id="open" class="open-btn">Открыть — 50 Taps</button>
        <div id="actions" class="actions">
          <button id="sell" class="a-btn sell">Продать</button>
          <button id="keep" class="a-btn keep">Сохранить</button>
        </div>
        <div id="drops" class="drops"></div>
      </div>
    </section>

    <!-- INVENTORY -->
    <section id="tab-inv" class="view" style="display:none"><div id="inv" class="inv"></div></section>

    <!-- пустой 4й -->
    <section id="tab-3" class="view" style="display:none"></section>
  </main>

  <nav class="segbar" id="segbar">
    <div class="seg is-active" data-tab="earn">Tap</div>
    <div class="seg" data-tab="case">Case</div>
    <div class="seg" data-tab="inv">Inventory</div>
    <div class="seg" data-tab="3">3</div>
  </nav>

  <footer>v43</footer>

<script>
(async function(){
  /* ---------- helpers first (чтобы точно были к моменту навигации) ---------- */
  function $(q){return document.querySelector(q)}
  function $$(q){return Array.from(document.querySelectorAll(q))}
  const on = (el,ev,fn)=>el && el.addEventListener(ev,fn,{passive:true});

  /* ---------- Telegram/WebApp ---------- */
  const tg = window.Telegram?.WebApp; try{ tg?.ready?.(); tg?.expand?.(); }catch(_){}

  /* ---------- Навигация: надёжная ---------- */
  const views = { earn:$('#tab-earn'), case:$('#tab-case'), inv:$('#tab-inv'), '3':$('#tab-3') };
  let active = 'earn', spinning = false, autoKeep = false;

  function showTab(tab){
    // защита от мусора
    if(!views[tab]) tab='earn';
    // «автосохранение» при уходе из кейса во время спина
    if(active==='case' && tab!=='case' && spinning) autoKeep = true;
    active = tab;

    // подсветка
    $$('#segbar .seg').forEach(s=>s.classList.toggle('is-active', s.dataset.tab===tab));
    // ПРИНУДИТЕЛЬНОЕ отображение (и класс, и style)
    Object.entries(views).forEach(([k,v])=>{
      const on = (k===tab);
      v.style.display = on ? 'block' : 'none';
      v.classList.toggle('is-active', on);
    });

    if(tab==='inv') drawInv();
    if(tab!=='case' && !spinning) resetOpen();
  }

  // делегирование на всю панель (чтобы точно поймать тап/клик)
  on($('#segbar'),'click', (e)=>{
    const btn = e.target.closest('.seg');
    if(btn && btn.dataset.tab) showTab(btn.dataset.tab);
  });
  on($('#segbar'),'touchstart', (e)=>{
    const btn = e.target.closest('.seg');
    if(btn && btn.dataset.tab) showTab(btn.dataset.tab);
  });

  /* ---------- Storage (CloudStorage + Local) ---------- */
  const PREFIX='v43:'; const cloud=tg?.cloudStorage||tg?.CloudStorage;
  const csGet=(k)=>new Promise(r=>cloud?.getItem?.(PREFIX+k,(e,v)=>r(v??null)) ?? r(null));
  const csSet=(k,v)=>new Promise(r=>cloud?.setItem?.(PREFIX+k,v,()=>r(true)) ?? r(false));
  const lsGet=(k)=>localStorage.getItem(PREFIX+k); const lsSet=(k,v)=>localStorage.setItem(PREFIX+k,v);
  async function storeGet(k,def=null){ let v=await csGet(k); if(v==null) v=lsGet(k); return v??def }
  async function storeSet(k,v){ lsSet(k,v); csSet(k,v).catch(()=>{}); }

  /* ---------- Баланс / TAP ---------- */
  let balance = parseInt(await storeGet('bal','0'),10) || 0;
  const drawBal=()=>{ $('#balance').textContent = balance };
  drawBal();

  on($('#tap'),'click', ()=>{
    balance++; storeSet('bal',String(balance)); drawBal(); flipCat();
  });
  let cat=false; function flipCat(){ $('#cat1').style.opacity=cat?0:1; $('#cat2').style.opacity=cat?1:0; cat=!cat; }

  /* ---------- CASE ---------- */
  const ITEMS=[
    {key:'business',name:'Деловой Рома',price:100,src:'roma_business.jpg'},
    {key:'kind',    name:'Добри Рома',  price:50, src:'roma_kind.jpg'},
    {key:'tough',   name:'Забивной Рома',price:25,src:'roma_tough.jpg'}
  ];
  const dropsEl=$('#drops'); dropsEl.innerHTML=ITEMS.map(i=>`
    <div class="drop"><img src="${i.src}"><div>${i.name}</div><div><b>${i.price} Taps</b></div></div>
  `).join('');

  const listEl=$('#case-list'), openWrap=$('#open-wrap'), backBtn=$('#back-btn');
  const preview=$('#preview'), reel=$('#reel'), track=$('#track'); const openBtn=$('#open'); const actions=$('#actions');
  const sfx=$('#sfx');

  on($('#case-card'),'click', enterOpen);
  on(backBtn,'click', ()=>{ if(!spinning) resetOpen(); });

  function enterOpen(){
    listEl.style.display='none'; openWrap.classList.add('is-active'); backBtn.style.display='inline-block';
    actions.classList.remove('is-active'); openBtn.disabled=false;
    track.innerHTML=''; track.style.transform='translate3d(0,0,0)'; reel.classList.remove('visible'); preview.classList.remove('hide');
  }
  function resetOpen(){
    openWrap.classList.remove('is-active'); listEl.style.display=''; backBtn.style.display='none';
    actions.classList.remove('is-active'); openBtn.disabled=true;
    track.innerHTML=''; track.style.transform='translate3d(0,0,0)'; reel.classList.remove('visible'); preview.classList.remove('hide');
  }

  const SPIN_MS=5500, RETURN_MS=280, OVERSHOOT=12, DPR=(window.devicePixelRatio||1);
  const snap=x=>Math.round(x*DPR)/DPR;
  preload(ITEMS.map(i=>i.src));

  let lastWin=null;
  on(openBtn,'click', async ()=>{
    if(spinning) return;
    if(balance<50){ tg?.showAlert?.('Недостаточно тапов'); return; }
    spinning=true; actions.classList.remove('is-active'); openBtn.disabled=true;
    balance-=50; await storeSet('bal',String(balance)); drawBal();
    try{sfx.currentTime=0; await sfx.play();}catch(_){}

    const prize = ITEMS[Math.floor(Math.random()*ITEMS.length)];
    await storeSet('pending', JSON.stringify({key:prize.key,t:Date.now()}));

    preview.classList.add('hide');
    setTimeout(async ()=>{
      reel.classList.add('visible');
      await nextFrame(); await nextFrame();

      const idx = buildTrack(prize);
      let cardW = measureCard(); if(!cardW){ await nextFrame(); cardW = measureCard() || (reel.clientWidth/3); }
      const center = (reel.clientWidth - cardW)/2;
      const distance = idx*cardW - center;

      startSpin(distance, idx, prize);
    },80);
  });

  function buildTrack(win){
    track.innerHTML='';
    const probe=document.createElement('div'); probe.className='card';
    probe.innerHTML=`<img src="${ITEMS[0].src}"><div class="label">${ITEMS[0].name}</div>`;
    track.appendChild(probe); let w=measureCard()||160; track.innerHTML='';

    const span=ITEMS.length;
    const visible=Math.max(3, Math.ceil(reel.clientWidth / w));
    const REP=Math.max(visible*12, 48);
    const mid=Math.floor(span/2), midRep=Math.floor(REP/2);
    const targetIndex = midRep*span + mid;

    for(let r=0;r<REP;r++){
      const arr=shuffle([...ITEMS]);
      if(r===midRep){ const i=arr.findIndex(x=>x.key===win.key); if(i!==-1) [arr[mid],arr[i]]=[arr[i],arr[mid]]; }
      for(const it of arr){
        const el=document.createElement('div'); el.className='card';
        el.innerHTML=`<img src="${it.src}"><div class="label">${it.name}</div>`;
        track.appendChild(el);
      }
    }
    return targetIndex;
  }
  function measureCard(){ const f=track.firstElementChild; return f ? (f.getBoundingClientRect().width || f.offsetWidth || 0) : 0; }
  function startSpin(distance, targetIndex, prize){
    const t0=performance.now();
    function anim(now){
      const p=Math.min((now-t0)/SPIN_MS,1);
      const eased=1 - Math.pow(1-p,3);
      track.style.transform=`translate3d(${snap(-distance*eased - OVERSHOOT)}px,0,0)`;
      if(p<1) requestAnimationFrame(anim); else bounce(distance,targetIndex,prize);
    }
    requestAnimationFrame(anim);
  }
  function bounce(distance, idx, prize){
    const t=performance.now();
    function step(now){
      const p=Math.min((now-t)/RETURN_MS,1);
      track.style.transform=`translate3d(${snap(-distance - OVERSHOOT*(1-p))}px,0,0)`;
      if(p<1) requestAnimationFrame(step); else finish(idx,prize);
    }
    requestAnimationFrame(step);
  }
  async function finish(idx, prize){
    [...track.children].forEach(c=>c.classList.remove('win'));
    track.children[idx]?.classList.add('win');
    spinning=false; openBtn.disabled=false; lastWin=prize;

    if(autoKeep || active!=='case'){
      await invAdd(prize); await storeSet('pending',""); autoKeep=false;
      tg?.showAlert?.(`Выпало: ${prize.name} — добавлено в инвентарь`);
      resetOpen();
    }else{
      $('#sell').textContent=`Продать — ${prize.price} Taps`;
      actions.classList.add('is-active');
    }
  }

  /* ---------- Inventory ---------- */
  const invEl=$('#inv');
  async function invGet(){ try{return JSON.parse(await storeGet('inv','[]'))}catch(_){return[]} }
  async function invSet(arr){ await storeSet('inv', JSON.stringify(arr)); }
  async function drawInv(){ const arr=await invGet(); invEl.innerHTML='';
    for(const it of arr){ const c=document.createElement('div'); c.className='inv-card';
      c.innerHTML=`<img src="${it.src}"><div>${it.name}</div>`; invEl.appendChild(c); } }
  async function invAdd(it){ const a=await invGet(); a.push({...it,id:Date.now().toString(36)}); await invSet(a); if(active==='inv') drawInv(); }
  async function invDel(id){ const a=await invGet(); await invSet(a.filter(x=>x.id!==id)); if(active==='inv') drawInv(); }

  on($('#keep'),'click', async ()=>{ if(!lastWin) return; await invAdd(lastWin); await storeSet('pending',""); actions.classList.remove('is-active'); tg?.showAlert?.('Сохранено'); });
  on($('#sell'),'click', async ()=>{ if(!lastWin) return; balance+=lastWin.price; await storeSet('bal',String(balance)); drawBal(); await storeSet('pending',""); actions.classList.remove('is-active'); tg?.showAlert?.(`Продано: +${lastWin.price}`); });

  /* ---------- Pending on start ---------- */
  try{
    const pend=await storeGet('pending','');
    if(pend){
      const p=JSON.parse(pend); const prize=ITEMS.find(x=>x.key===p.key);
      if(prize){ await invAdd(prize); await storeSet('pending',""); }
    }
  }catch(_){}

  /* ---------- Reset ---------- */
  on($('#reset-btn'),'click', async ()=>{
    Object.keys(localStorage).filter(k=>k.startsWith(PREFIX)).forEach(k=>localStorage.removeItem(k));
    await csSet('bal','0'); await csSet('inv','[]'); await csSet('pending','');
    balance=0; drawBal(); await drawInv(); tg?.showAlert?.('Сброшено');
  });

  /* ---------- utils ---------- */
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a }
  function nextFrame(){ return new Promise(r=>requestAnimationFrame(()=>r())) }
  function preload(srcs){ srcs.forEach(s=>{ const i=new Image(); i.src=s; }); }

  // стартовая вкладка
  showTab('earn');
})();
</script>
</body>
</html>
