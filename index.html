<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mini App — Tap / Case / Inventory (v31)</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root{
    --gap:18px;
    --bg1:#0f0f16; --bg2:#15182b; --fg:#eaeaea;
    --accent:#ff3b30; --brand1:#7c3aed; --brand2:#ff3b81;
    --glass:rgba(255,255,255,.06); --glass-border:rgba(255,255,255,.22);
    --seg-h:54px;

    /* рулетка почти на всю ширину */
    --stage-w: min(92vw, 560px);
    --stage-h: clamp(200px, 52vw, 360px);
    --card-w : clamp(120px, 28vw, 220px);
  }
  html,body{height:100%;margin:0}
  *{-webkit-tap-highlight-color:transparent}
  body{
    color:var(--fg); font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
    user-select:none; overflow:hidden; position:relative;
    background:
      radial-gradient(1200px 600px at 20% -10%, rgba(124,58,237,.25), transparent 60%),
      radial-gradient(1000px 800px at 100% 120%, rgba(255,59,129,.18), transparent 70%),
      linear-gradient(180deg,var(--bg1),var(--bg2));
  }

  /* баланс */
  #wallet{position:fixed;top:10px;right:10px;z-index:30;display:inline-flex;align-items:center;gap:8px;
    padding:8px 12px;font-size:14px;background:var(--glass);border:1px solid var(--glass-border);
    border-radius:12px;backdrop-filter:blur(4px);box-shadow:0 8px 24px rgba(0,0,0,.25)}
  #wallet img{width:22px;height:22px;display:block}

  /* верхние кнопки */
  #reset-btn,#back-cases{
    position:fixed;left:10px;z-index:30;padding:8px 12px;font-size:12px;letter-spacing:.3px;color:var(--fg);
    background:var(--glass);border:1px solid var(--glass-border);border-radius:12px;backdrop-filter:blur(4px);
    cursor:pointer;outline:none
  }
  #reset-btn{top:10px}
  #back-cases{top:44px;display:none}

  /* FX */
  #fx-layer{position:fixed;inset:0;pointer-events:none;z-index:5}
  .spark{position:fixed;width:6px;height:6px;border-radius:50%;background:currentColor;opacity:.95;
    transform:translate(0,0) rotate(0deg);animation:pop var(--dur,700ms) ease-out forwards}
  @keyframes pop{80%{opacity:1}100%{transform:translate(var(--tx,0),var(--ty,0)) rotate(var(--rot,0deg));opacity:0}}

  /* нижняя панель — полупрозрачная с blur, лежит СВЕРХУ контента */
  .segbar{position:fixed;z-index:25;left:0;right:0;bottom:0;height:calc(var(--seg-h) + env(safe-area-inset-bottom,0));
    display:grid;grid-template-columns:repeat(4,1fr);
    background:rgba(10,11,18,.68); backdrop-filter: blur(10px) saturate(120%);
    border-top:1px solid var(--glass-border); overflow:hidden}
  .seg{display:grid;place-items:center;font-size:12px;color:#cfd3ff}
  .seg + .seg{border-left:1px solid rgba(255,255,255,.08)}
  .seg.is-active{color:#fff;background:rgba(255,255,255,.10);box-shadow:inset 0 2px rgba(255,255,255,.25)}
  footer{position:fixed;bottom:calc(var(--seg-h) + 4px + env(safe-area-inset-bottom,0));left:8px;font-size:12px;opacity:.45;z-index:16}

  /* контейнер вкладок: НА ВЕСЬ ЭКРАН, без нижнего паддинга — контент уходит под панель */
  main{
    width:100%;max-width:100%;
    height:100dvh;
    padding:16px 12px 8px;
    box-sizing:border-box; overflow:hidden;
  }
  .view{display:none;position:relative}
  .view.is-active{display:block}
  .view:not(.is-active){display:none!important}

  /* TAP центр */
  #tab-earn{width:100%;height:100%}
  .tap-center{height:100%;display:grid;place-items:center}
  .tap-wrap{position:relative}
  .tap-cat{position:absolute;left:50%;transform:translateX(-50%) translateY(-10px);bottom:100%;height:90px;pointer-events:none}
  .tap-cat img{position:absolute;left:50%;transform:translateX(-50%);top:0;height:90px;transition:opacity .08s ease}
  #cat-a{opacity:1} #cat-b{opacity:0}
  .btn{font-size:clamp(22px,5vw,40px);text-transform:uppercase;padding:22px 46px;border:0;border-radius:18px;color:#fff;cursor:pointer;background:linear-gradient(135deg,var(--accent),#ff6a55);box-shadow:0 16px 40px rgba(255,59,48,.25), inset 0 -3px rgba(0,0,0,.25)}

  /* CASE — список */
  #tab-1{width:100%;height:100%;overflow:auto}
  .case-host{display:grid;justify-items:center;align-content:start;gap:14px;padding-top:8vh}
  .cases-list{display:grid;grid-template-columns:1fr;justify-items:center;gap:14px;width:100%}
  .case-card{display:grid;gap:10px;justify-items:center;padding:14px;border-radius:14px;background:linear-gradient(135deg,rgba(124,58,237,.16),rgba(255,59,129,.12));border:1px solid var(--glass-border);box-shadow:inset 0 1px rgba(255,255,255,.08);cursor:pointer}
  /* картинка кейса — полностью, без обрезки */
  .case-card img{width:min(70vw, 340px);height:auto;object-fit:contain;border-radius:12px}
  .case-title{font-weight:800}
  .case-card .price{font-weight:800;font-size:16px;opacity:.9}

  /* экран открытия кейса */
  .case-open-view{display:none}
  .case-open-view.is-active{display:block}
  .case-stage{position:relative;width:var(--stage-w);height:var(--stage-h);margin:0 auto;border-radius:14px}
  .case-preview{position:absolute;inset:0;border-radius:14px;overflow:hidden;opacity:1;transition:opacity 400ms ease}
  .case-preview.hide{opacity:0}
  .case-preview img{width:100%;height:100%;object-fit:contain} /* не режем */

  .reel{position:absolute;inset:0;opacity:0;overflow:hidden;border-radius:14px;border:1px solid var(--glass-border);background:rgba(255,255,255,.06);transition:opacity 300ms ease}
  .reel.visible{opacity:1}
  .reel::after{content:'';position:absolute;top:0;bottom:0;left:50%;width:2px;transform:translateX(-1px);background:linear-gradient(180deg,transparent,rgba(255,255,255,.75),transparent)}
  .reel-track{display:flex;align-items:center;height:100%;will-change:transform;transform:translateZ(0)}

  .card{flex:0 0 var(--card-w);width:var(--card-w);height:100%;display:grid;grid-template-rows:1fr auto;align-items:stretch;justify-items:center;gap:6px}
  .card img{width:calc(var(--card-w) - 6px);height:calc(var(--stage-h) - 60px);object-fit:contain;border-radius:10px;border:1px solid var(--glass-border);background:rgba(0,0,0,.15)}
  .card .label{font-size:13px;margin-bottom:8px;opacity:.95}
  .card.win .label{color:#ffd400;text-shadow:0 0 14px rgba(255,212,0,.5)}

  .open-btn{display:block;margin:12px auto 10px;padding:14px 22px;border-radius:14px;border:0;color:#fff;cursor:pointer;background:linear-gradient(135deg,var(--brand1),var(--brand2));box-shadow:0 12px 28px rgba(124,58,237,.32)}
  .actions{display:none;gap:10px;justify-content:center}
  .actions.is-active{display:grid;grid-auto-flow:column}
  .a-btn{padding:12px 18px;border-radius:12px;border:0;color:#fff;cursor:pointer}
  .sell{background:linear-gradient(135deg,#0ea5e9,#2563eb)}
  .keep{background:linear-gradient(135deg,#22c55e,#16a34a)}

  /* список возможных предметов — БЕЗ отступа снизу: уходит под панель */
  .drops{margin:18px auto 0;max-width:var(--stage-w);
         display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  .drop{background:rgba(255,255,255,.06);border:1px solid var(--glass-border);border-radius:12px;padding:8px;display:grid;gap:6px;justify-items:center}
  .drop img{width:100%;height:120px;object-fit:contain;background:rgba(0,0,0,.15);border:1px solid var(--glass-border);border-radius:8px}
  .drop .t{font-size:12px;text-align:center}
  .drop .p{font-weight:800}

  /* INVENTORY */
  #tab-2{width:100%;height:100%;overflow:auto}
  .inv-grid{width:100%;display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px}
  .inv-card{background:rgba(255,255,255,.06);border:1px solid var(--glass-border);border-radius:12px;padding:8px;display:grid;gap:6px;justify-items:center}
  .inv-card img{width:100%;height:110px;object-fit:contain;border-radius:8px;border:1px solid var(--glass-border);background:rgba(0,0,0,.15)}
</style>
</head>
<body>
  <div id="wallet"><img src="hand.png" alt=""><span id="balance">0</span></div>
  <button id="reset-btn">обнуление</button>
  <button id="back-cases">назад</button>
  <div id="fx-layer"></div>

  <main id="views">
    <!-- TAP -->
    <section id="tab-earn" class="view is-active">
      <div class="tap-center">
        <div class="tap-wrap">
          <div class="tap-cat"><img id="cat-a" src="cat1.png"><img id="cat-b" src="cat2.png"></div>
          <button id="hello-btn" class="btn">TAP</button>
        </div>
      </div>
    </section>

    <!-- CASE -->
    <section id="tab-1" class="view">
      <div class="case-host">
        <div id="cases-list" class="cases-list">
          <div class="case-card" id="case-card" role="button" tabindex="0">
            <div class="case-title">Сезонный Рома</div>
            <img src="case.png" alt="">
            <div class="price">50 Taps</div>
          </div>
        </div>

        <section id="case-open-view" class="case-open-view" aria-hidden="true">
          <div class="case-stage">
            <div id="case-preview" class="case-preview"><img src="case.png" alt=""></div>
            <div class="reel" id="reel"><div class="reel-track" id="reel-track"></div></div>
          </div>
          <button id="case-open" class="open-btn">Открыть — 50 Taps</button>
          <div class="actions" id="case-actions">
            <button class="a-btn sell" id="sell-btn">Продать</button>
            <button class="a-btn keep" id="keep-btn">Сохранить</button>
          </div>
          <div class="drops" id="drops"></div>
        </section>
      </div>
    </section>

    <!-- INVENTORY -->
    <section id="tab-2" class="view">
      <div class="inv-grid" id="inv-grid"></div>
    </section>

    <section id="tab-3" class="view"></section>
  </main>

  <nav class="segbar">
    <div class="seg is-active" data-tab="earn">Tap</div>
    <div class="seg" data-tab="1">Case</div>
    <div class="seg" data-tab="2">Inventory</div>
    <div class="seg" data-tab="3">3</div>
  </nav>

  <footer>v31</footer>

<script>
(function(){
  const tg = window.Telegram?.WebApp; tg?.ready?.(); tg?.expand?.();

  /* ——— навигация */
  const tabs  = Array.from(document.querySelectorAll('.segbar .seg'));
  const views = { earn:$('#tab-earn'), '1':$('#tab-1'), '2':$('#tab-2'), '3':$('#tab-3') };
  tabs.forEach(t=>t.addEventListener('click',()=>switchTo(t.dataset.tab)));
  function switchTo(name){
    tabs.forEach(t=>t.classList.toggle('is-active', t.dataset.tab===name));
    Object.entries(views).forEach(([k,v])=>v.classList.toggle('is-active', k===name));
    if(name==='1') views['1'].scrollTo({top:0,behavior:'auto'});
    if(name!=='1') resetCaseView();
  }

  /* ——— баланс + тап */
  const KEY_BAL = 'tapper-count:'+ (tg?.initDataUnsafe?.user?.id ?? 'anon');
  let balance = +(localStorage.getItem(KEY_BAL)||0);
  const $bal = $('#balance'); const saveBal=()=>localStorage.setItem(KEY_BAL,String(balance)); const drawBal=()=>($bal.textContent=balance);
  drawBal();

  $('#hello-btn').addEventListener('click', (ev)=>{ spawnSparks(ev); balance++; saveBal(); drawBal(); flipCat(); });

  function spawnSparks(ev){
    const btn=$('#hello-btn'), r=btn.getBoundingClientRect(), cx=r.left+r.width/2, cy=r.top+r.height/2;
    const color=getComputedStyle(btn).backgroundColor||'#fff';
    for(let i=0;i<18;i++){
      const s=document.createElement('span'); s.className='spark';
      const a=(Math.PI*2)*(i/18)+(Math.random()*0.5), d=40+Math.random()*70;
      s.style.left=cx+'px'; s.style.top=cy+'px';
      s.style.setProperty('--tx', Math.cos(a)*d+'px');
      s.style.setProperty('--ty', Math.sin(a)*d+'px');
      s.style.setProperty('--rot', (a*180/Math.PI + (Math.random()*40-20))+'deg');
      s.style.setProperty('--dur', (500+Math.random()*500)+'ms');
      s.style.color=color; $('#fx-layer').appendChild(s); s.addEventListener('animationend',()=>s.remove());
    }
  }
  let flip=false; function flipCat(){ $('#cat-a').style.opacity=flip?0:1; $('#cat-b').style.opacity=flip?1:0; flip=!flip; }

  /* ——— CASE */
  const tabCase      = views['1'];
  const casesList    = $('#cases-list');
  const openView     = $('#case-open-view');
  const casePreview  = $('#case-preview');
  const caseOpen     = $('#case-open');
  const actions      = $('#case-actions');
  const sellBtn      = $('#sell-btn');
  const keepBtn      = $('#keep-btn');
  const dropsEl      = $('#drops');
  const reel         = $('#reel');
  const track        = $('#reel-track');
  const backBtn      = $('#back-cases');

  const ITEMS = [
    { key:'business', name:'Деловой Рома', price:100, src:'roma_business.jpg' },
    { key:'kind',     name:'Добри Рома',   price:50,  src:'roma_kind.jpg' },
    { key:'tough',    name:'Забивной Рома',price:25,  src:'roma_tough.jpg' }
  ];
  renderDrops();

  let selectedCost=null, spinning=false, lastWin=null;

  $('#case-card').addEventListener('click', openCase);
  backBtn.addEventListener('click', ()=>{ if(!spinning) resetCaseView(); });

  function openCase(){
    selectedCost=50; tabCase.scrollTo({top:0,behavior:'auto'});
    casesList.style.display='none'; openView.classList.add('is-active'); backBtn.style.display='inline-block';
    caseOpen.disabled=false; actions.classList.remove('is-active'); lastWin=null;
    track.innerHTML=''; reel.classList.remove('visible'); casePreview.classList.remove('hide');
  }
  function resetCaseView(){
    openView.classList.remove('is-active'); casesList.style.display=''; backBtn.style.display='none';
    selectedCost=null; caseOpen.disabled=true; actions.classList.remove('is-active'); lastWin=null;
    track.innerHTML=''; reel.classList.remove('visible'); casePreview.classList.remove('hide');
  }

  /* ——— плавная анимация 3.5s: быстрый старт → равномерное плавное замедление */
  const SPIN_MS = 3500; // длительность
  caseOpen.addEventListener('click', ()=>{
    if(spinning) return;
    const cost = selectedCost||50;
    if(balance < cost) { tg?.showAlert?.('Недостаточно тапов'); return; }
    spinning=true; caseOpen.disabled=true; actions.classList.remove('is-active');
    balance -= cost; saveBal(); drawBal();

    const prize = ITEMS[Math.floor(Math.random()*ITEMS.length)]; lastWin = prize;
    buildTrackWithWin(prize);

    casePreview.classList.add('hide');
    setTimeout(()=>{ reel.classList.add('visible'); }, 80);

    requestAnimationFrame(()=>{
      const first = track.querySelector('.card');
      const w = first ? first.getBoundingClientRect().width : parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--card-w')) || 160;
      const center = (reel.clientWidth - w)/2;
      const span = ITEMS.length, mid = Math.floor(span/2), rep=5;
      const idx = (rep-1)*span + mid;
      const distance = idx*w - center;   // сколько «пролететь»

      const t0 = performance.now();
      const easeOutCubic = t => 1 - Math.pow(1 - t, 3); // плавное замедление
      (function tick(now){
        const p = Math.min((now - t0) / SPIN_MS, 1);
        const eased = easeOutCubic(p);
        track.style.transform = `translateX(${-distance * eased}px)`;
        if (p < 1) requestAnimationFrame(tick);
        else {
          highlightWin(idx);
          spinning=false; caseOpen.disabled=false;
          actions.classList.add('is-active');
          sellBtn.textContent=`Продать — ${lastWin.price} Taps`;
        }
      })(t0);
    });
  });

  function buildTrackWithWin(win){
    track.innerHTML='';
    const span=ITEMS.length, mid=Math.floor(span/2), rep=5;
    for(let r=0;r<rep;r++){
      const arr=shuffle(ITEMS.slice());
      if(r===rep-1){
        const i=arr.findIndex(x=>x.key===win.key);
        if(i!==-1){ const t=arr[mid]; arr[mid]=arr[i]; arr[i]=t; }
      }
      for(const it of arr){
        const el=document.createElement('div'); el.className='card';
        const img=document.createElement('img'); img.alt=it.name; img.src=it.src;
        const lab=document.createElement('div'); lab.className='label'; lab.textContent=it.name;
        el.appendChild(img); el.appendChild(lab); track.appendChild(el);
      }
    }
  }
  function highlightWin(i){ [...track.children].forEach(e=>e.classList.remove('win')); track.children[i]?.classList.add('win'); }
  function renderDrops(){
    dropsEl.innerHTML='';
    for(const it of ITEMS){
      const d=document.createElement('div'); d.className='drop';
      d.innerHTML = `<img src="${it.src}" alt=""><div class="t">${it.name}</div><div class="p">${it.price} Taps</div>`;
      dropsEl.appendChild(d);
    }
  }

  /* ——— inventory (минимум) */
  const KEY_INV = 'inventory:'+ (tg?.initDataUnsafe?.user?.id ?? 'anon');
  const invGrid = $('#inv-grid');
  function invGet(){ try{return JSON.parse(localStorage.getItem(KEY_INV)||'[]');}catch(_){return[]} }
  function invSet(v){ localStorage.setItem(KEY_INV, JSON.stringify(v)); }
  function invAdd(it){ const a=invGet(); a.push({...it,id:Date.now().toString(36)}); invSet(a); drawInv(); }
  function drawInv(){
    const inv=invGet(); invGrid.innerHTML='';
    if(!inv.length) return;
    for(const it of inv){
      const c=document.createElement('div'); c.className='inv-card';
      c.innerHTML=`<img src="${it.src}" alt="${it.name}"><div class="title">${it.name}</div>`;
      invGrid.appendChild(c);
    }
  }
  drawInv();

  $('#keep-btn').addEventListener('click', ()=>{ if(!lastWin) return; invAdd(lastWin); actions.classList.remove('is-active'); tg?.showAlert?.('Сохранено в инвентарь'); });
  $('#sell-btn').addEventListener('click', ()=>{ if(!lastWin) return; balance+=lastWin.price; saveBal(); drawBal(); actions.classList.remove('is-active'); tg?.showAlert?.(`Продано: +${lastWin.price}`); });

  /* helpers */
  function $(q){return document.querySelector(q)}
  function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }
})();
</script>
</body>
</html>
