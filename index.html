<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Мини‑апп — пост‑панк + уровни (v7)</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --gap: 18px;
      --bg: #0a0a0a;   /* тёмный фон */
      --fg: #eaeaea;   /* светлый текст */
      --red:    #ff3b30;
      --blue:   #2d9cff;
      --green:  #2ecc71;
      --yellow: #ffd400;
    }
    html, body { height: 100%; margin: 0; }
    * { -webkit-tap-highlight-color: transparent; }
    body {
      display: grid; place-items: center; background: var(--bg); color: var(--fg);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      user-select: none; overflow: hidden; position: relative;
      background-image:
        radial-gradient(1200px 600px at 50% 20%, rgba(255,255,255,.04), transparent 60%),
        radial-gradient(800px 800px at 80% 120%, rgba(255,255,255,.035), transparent 70%),
        repeating-linear-gradient(0deg, rgba(255,255,255,.03) 0px, rgba(255,255,255,.03) 1px, transparent 2px, transparent 3px);
      background-blend-mode: screen;
    }

    /* кнопка обнуления */
    #reset-btn {
      position: fixed; top: 10px; left: 10px; z-index: 10;
      padding: 6px 10px; font-size: 12px; letter-spacing: .3px; text-transform: lowercase;
      color: var(--fg); background: rgba(255,255,255,.06);
      border: 1px dashed rgba(255,255,255,.35); border-radius: 10px;
      backdrop-filter: blur(2px); cursor: pointer; outline: none; -webkit-appearance: none;
      transition: opacity .2s ease, transform .05s ease;
    }
    #reset-btn:focus, #reset-btn:focus-visible { outline: none; }
    #reset-btn:hover { opacity: .95; }
    #reset-btn:active { transform: translateY(1px); }

    /* слой для искр */
    #fx-layer { position: fixed; inset: 0; pointer-events: none; overflow: hidden; }

    main { display: grid; justify-items: center; gap: var(--gap); }

    .btn {
      font-size: clamp(24px, 6vw, 44px);
      letter-spacing: 1px; text-transform: uppercase;
      padding: 26px 56px;
      border: 2px solid #111; border-radius: 18px;
      color: #fff; cursor: pointer; outline: none; -webkit-appearance: none;
      box-shadow: 0 10px 26px rgba(0,0,0,.35), inset 0 -3px rgba(0,0,0,.25);
      transition: transform .06s ease, filter .2s ease, background .2s ease;
      position: relative;
    }
    .btn:focus, .btn:focus-visible { outline: none; }
    .btn:active { transform: translateY(1px) scale(0.995); }

    /* цвета уровней */
    .btn--red    { background: var(--red);    box-shadow: 0 10px 26px rgba(255,59,48,.3), inset 0 -3px rgba(0,0,0,.25); }
    .btn--blue   { background: var(--blue);   box-shadow: 0 10px 26px rgba(45,156,255,.3), inset 0 -3px rgba(0,0,0,.25); }
    .btn--green  { background: var(--green);  box-shadow: 0 10px 26px rgba(46,204,113,.3), inset 0 -3px rgba(0,0,0,.25); }
    .btn--yellow { background: var(--yellow); color:#111; box-shadow: 0 10px 26px rgba(255,212,0,.35), inset 0 -3px rgba(0,0,0,.2); }

    /* «наклейки» */
    .sticker {
      background: rgba(255,255,255,.06);
      border: 1px dashed rgba(255,255,255,.25);
      padding: 8px 12px; border-radius: 10px; backdrop-filter: blur(2px);
      transform: rotate(-1.25deg);
    }
    .counter { font-size: clamp(18px, 4vw, 22px); opacity:.95; }
    .hint { font-size: 12px; opacity:.65; transform: rotate(0.75deg); margin-top: -6px; }

    /* искры */
    .spark {
      position: absolute; width: 2px; height: 10px; border-radius: 1px; opacity: 0;
      transform: translate(0,0) rotate(var(--rot,0deg));
      background: currentColor;
      filter: drop-shadow(0 0 4px currentColor);
      animation: spark-move var(--dur,700ms) cubic-bezier(.2,.7,.2,1) forwards;
    }
    @keyframes spark-move {
      0% { opacity: 1; transform: translate(0,0) rotate(var(--rot)); }
      90% { opacity: 1; }
      100% { opacity: 0; transform: translate(var(--tx, 0), var(--ty, 0)) rotate(var(--rot)) scale(.8); }
    }

    footer { position: fixed; bottom: 8px; left: 8px; font-size: 12px; opacity:.45 }
  </style>
</head>
<body>
  <button id="reset-btn" aria-label="обнулить прогресс">обнуление</button>
  <div id="fx-layer"></div>
  <main>
    <button id="hello-btn" class="btn btn--red" aria-label="привет">ПРИВЕТ</button>
    <p class="sticker counter">Нажатий: <span id="count" aria-live="polite">0</span></p>
    <p class="sticker hint" id="goal"></p>
  </main>
  <footer>v7</footer>

  <script>
    (function () {
      const tg = window.Telegram && Telegram.WebApp ? Telegram.WebApp : null;
      if (tg) { tg.ready(); tg.expand(); }

      const LEVELS = ['red', 'blue', 'green', 'yellow'];
      const TARGETS = { red: 10, blue: 50, green: 100, yellow: Infinity };
      const COLORS  = { red: getComputedStyle(document.documentElement).getPropertyValue('--red').trim(),
                        blue: getComputedStyle(document.documentElement).getPropertyValue('--blue').trim(),
                        green: getComputedStyle(document.documentElement).getPropertyValue('--green').trim(),
                        yellow: getComputedStyle(document.documentElement).getPropertyValue('--yellow').trim() };

      const userId = tg?.initDataUnsafe?.user?.id ?? 'anon';
      const STORAGE_KEY = `hello-state:${userId}`;

      const btn = document.getElementById('hello-btn');
      const countEl = document.getElementById('count');
      const goalEl  = document.getElementById('goal');
      const fxLayer = document.getElementById('fx-layer');
      const resetBtn = document.getElementById('reset-btn');

      let state = { level: 'red', count: 0 };
      try { const saved = localStorage.getItem(STORAGE_KEY); if (saved) state = JSON.parse(saved); } catch(_){}
      if (!LEVELS.includes(state.level) || typeof state.count !== 'number') state = { level:'red', count:0 };

      function save(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(_){} }
      function clear(){ try{ localStorage.removeItem(STORAGE_KEY); }catch(_){} }

      function applyLevel(){
        btn.classList.remove('btn--red','btn--blue','btn--green','btn--yellow');
        btn.classList.add(`btn--${state.level}`);
        const target = TARGETS[state.level];
        goalEl.textContent = state.level === 'yellow' ? 'Жёлтый уровень — кликай бесконечно.' : `Цель на этом уровне: ${target}.`;
      }
      function render(){ countEl.textContent = state.count; }

      applyLevel(); render();

      btn.addEventListener('click', (ev) => {
        spawnSparks(ev);
        state.count += 1;
        const target = TARGETS[state.level];
        if (state.count >= target) {
          state.count = 0;
          const idx = LEVELS.indexOf(state.level);
          if (state.level !== 'yellow' && idx < LEVELS.length - 1) {
            state.level = LEVELS[idx + 1];
            applyLevel();
          }
        }
        render();
        save();
      });

      resetBtn.addEventListener('click', async () => {
        // подтверждение сброса
        if (tg && typeof tg.showPopup === 'function') {
          tg.showPopup({
            title: 'Обнуление',
            message: 'Сбросить весь прогресс? Это действие необратимо.',
            buttons: [
              { id: 'yes', type: 'destructive', text: 'Сбросить' },
              { type: 'cancel' }
            ]
          }, (btnId) => { if (btnId === 'yes') doReset(); });
        } else {
          if (window.confirm('Сбросить весь прогресс?')) doReset();
        }
      });

      function doReset(){
        state = { level:'red', count:0 };
        clear();
        applyLevel();
        render();
        if (tg && typeof tg.showAlert === 'function') tg.showAlert('Прогресс обнулён');
      }

      function spawnSparks(ev){
        const rect = btn.getBoundingClientRect();
        const cx = rect.left + rect.width/2; // центр кнопки
        const cy = rect.top  + rect.height/2;
        const color = COLORS[state.level] || '#fff';
        const n = 18;
        for (let i=0;i<n;i++){
          const s = document.createElement('span');
          s.className = 'spark';
          const angle = (Math.PI * 2) * (i/n) + (Math.random()*0.5);
          const dist = 40 + Math.random()*70;
          const tx = Math.cos(angle) * dist + 'px';
          const ty = Math.sin(angle) * dist + 'px';
          const rot = (angle*180/Math.PI + (Math.random()*40-20)) + 'deg';
          const dur = (500 + Math.random()*500) + 'ms';
          s.style.left = (cx) + 'px';
          s.style.top  = (cy) + 'px';
          s.style.setProperty('--tx', tx);
          s.style.setProperty('--ty', ty);
          s.style.setProperty('--rot', rot);
          s.style.setProperty('--dur', dur);
          s.style.color = color;
          fxLayer.appendChild(s);
          s.addEventListener('animationend', ()=> s.remove());
        }
      }
    })();
  </script>
</body>
</html>
